@model List<LibraryManagement.Models.BookModel>

@{
    ViewData["Title"] = "Book Management";
}

<style>
    .book-container {
        padding: 25px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 600;
        margin: 0;
    }

    .action-icons a {
        margin: 0 5px;
        cursor: pointer;
        font-size: 18px;
        text-decoration: none
    }

    .action-icons .view-icon {
        color: #0d6efd;
    }

    .action-icons .edit-icon {
        color: #198754;
    }

    .action-icons .delete-icon {
        color: #dc3545;
    }

    .modal-header {
        background-color: #f8f9fa;
    }

    .form-label {
        font-weight: 500;
    }

    .form-control.is-valid,
    .form-control.is-invalid {
        background-image: none !important;
        padding-right: 0.75rem !important;
    }
</style>

<div class="book-container">
    <div class="page-header">
        <h2 class="page-title">Book Management</h2>
        <button class="btn btn-primary" id="btnAddBook">
            <i class="bi bi-plus-circle"></i> Add New Book
        </button>
    </div>

    <div class="table-responsive">
        <table id="booksTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>Book Name</th>
                    <th>Book Author</th>
                    <th>ISBN</th>
                    <th>Published Year</th>
                    <th>Quantity</th>
                    <th>Available</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ADD / EDIT BOOK MODAL -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="bookModalLabel">Add Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="bookForm" novalidate>
                    <input type="hidden" id="bookUid" />

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Book Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" placeholder="Enter a Book Name" required>
                            <div class="invalid-feedback">Book Name is required.</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Book Author <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="author" placeholder="Enter a Book Author" required>
                            <div class="invalid-feedback">Book Author is required.</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ISBN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="isbn"
                                   placeholder="Enter ISBN Number"
                                   maxlength="13"
                                   inputmode="numeric"
                                   pattern="[0-9]*"
                                   required>
                            <div class="invalid-feedback">
                                ISBN is required and must be exactly 13 digits.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Published Year <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="publishedYear"
                                   placeholder="Enter Published Year"
                                   min="1000" max="2100" required>
                            <div class="invalid-feedback" id="publishedYearError">
                                Published Year is required.
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Total Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="quantity"
                                   placeholder="Enter Total Quantity" min="1" required>
                            <div class="invalid-feedback">Total Quantity is required.</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Available Copies <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="availableCopies"
                                   placeholder="Enter Available Copies" min="0" required>
                            <div class="invalid-feedback">Available Copies is required.</div>
                        </div>
                    </div>

                    <div class="row created-date-row d-none">
                        <div class="col-md-6 mb-3">
                            <label>Created Date</label>
                            <input type="text" id="createdDate" class="form-control" readonly />
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveBook">Save Book</button>
            </div>
        </div>
    </div>
</div>

<!-- VIEW BOOK MODAL -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Book Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Book Name</label>
                            <input type="text" id="viewTitle" class="form-control" disabled />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Book Author</label>
                            <input type="text" id="viewAuthor" class="form-control" disabled />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ISBN</label>
                            <input type="text" id="viewIsbn" class="form-control" disabled />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Published Year</label>
                            <input type="text" id="viewPublishedYear" class="form-control" disabled />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Total Quantity</label>
                            <input type="text" id="viewQuantity" class="form-control" disabled />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Available Copies</label>
                            <input type="text" id="viewAvailableCopies" class="form-control" disabled />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Created Date</label>
                            <input type="text" id="viewCreatedDate" class="form-control" disabled />
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        var dataTable;
        var bookData = @Html.Raw(Json.Serialize(Model));

        toastr.options = {
            closeButton: true,
            progressBar: true,
            positionClass: "toast-top-right",
            timeOut: "1500",
            extendedTimeOut: "3000",
            showDuration: "300",
            hideDuration: "1000",
            showMethod: "fadeIn",
            hideMethod: "fadeOut"
        };

        $('#bookModal').on('hidden.bs.modal', function () {
            $('#bookForm .is-invalid').removeClass('is-invalid');
            $('#bookForm .is-valid').removeClass('is-valid');

            if ($('#btnSaveBook').data('mode') !== 'edit') {
                $('#bookForm')[0].reset();
            }
        });

        $('#isbn').on('input', function () {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        function resetForm() {
            $('#bookForm')[0].reset();
            $('#bookUid').val('');
        }

        function showBootstrapValidation() {
            let isValid = true;

            $('#bookForm input[required]').each(function () {
                const value = $(this).val().trim();
                const id = $(this).attr('id');

                if (!value) {
                    if (id === 'publishedYear') {
                        $('#publishedYearError').text("Published Year is required.");
                    }

                    $(this).addClass('is-invalid').removeClass('is-valid');
                    isValid = false;
                }
                else if (id === 'isbn' && value.length !== 13) {
                    $(this).addClass('is-invalid').removeClass('is-valid');
                    isValid = false;
                }
                else {
                    $(this).removeClass('is-invalid').removeClass('is-valid');
                }
            });

            return isValid;
        }

        function formatDateTimeAMPM(dateValue) {
            if (!dateValue) return "";

            const d = new Date(dateValue);

            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');

            let hours = d.getHours();
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');

            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;

            // ✅ SINGLE SPACE BETWEEN DATE & TIME
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} ${ampm}`;
        }






        function validateForm() {
            var quantity = parseInt($('#quantity').val());
            var available = parseInt($('#availableCopies').val());

            if (available > quantity) {
                toastr.error("Available Copies cannot be more than Total Quantity");
                return false;
            }
            return true;
        }



        function viewBook(bookUid) {

            console.log("VIEW CLICKED → bookUid =", bookUid);

            $.ajax({
                url: `/Book/Details/${bookUid}`,
                type: "GET",
                success: function (response) {

                    console.log("AJAX SUCCESS:", response);

                    if (response.success === false) {
                        alert(response.message || "Book not found");
                        return;
                    }

                    var book = response.data;
                    console.log(book);
                    $('#viewTitle').val(book.title);
                    $('#viewAuthor').val(book.author);
                    $('#viewIsbn').val(book.isbn);
                    $('#viewPublishedYear').val(book.publishedYear ?? "N/A");
                    $('#viewQuantity').val(book.quantity);
                    $('#viewAvailableCopies').val(book.availableCopies);

                                       $('#viewCreatedDate').val(
            formatDateTimeAMPM(book.CreatedDate || book.createdDate)
        );




                    // clear validation leftovers (safe)
                    $('#bookForm .is-invalid').removeClass('is-invalid');
                    $('#bookForm .is-valid').removeClass('is-valid');

                    // ✅ BOOTSTRAP 5 MODAL OPEN
                    var viewModal = new bootstrap.Modal(
                        document.getElementById('viewModal')
                    );
                    viewModal.show();
                },
                error: function (xhr) {
                    console.log("AJAX ERROR:", xhr.responseText);
                    alert("Error fetching book details");
                }
            });
        }



        function editBook(bookUid) {

            console.log("EDIT CLICKED → bookUid =", bookUid);

            $.ajax({
                url: `/Book/Details/${bookUid}`,
                type: "GET",
                success: function (response) {

                    if (!response.success) {
                        alert("Book not found");
                        return;
                    }

                    var b = response.data;

                    $("#bookUid").val(b.bookUid);
                    $("#title").val(b.title);
                    $("#author").val(b.author);
                    $("#isbn").val(b.isbn);
                    $("#publishedYear").val(b.publishedYear);
                    $("#quantity").val(b.quantity);
                    $("#availableCopies").val(b.availableCopies);

                    // Enable editable inputs
                    $("#bookForm input").prop("disabled", false);

                    $("#bookModalLabel").text("Edit Book");
                    $("#btnSaveBook").data("mode", "edit");

                    $('#bookForm .is-invalid').removeClass('is-invalid');
                    $('#bookForm .is-valid').removeClass('is-valid');

                    // ✅ SHOW CreatedDate
                    $('.created-date-row').removeClass('d-none');

                    // ✅ DISABLE CreatedDate field
                    $("#createdDate").prop("disabled", true);

                    // ✅ SET CreatedDate VALUE (date + time AM/PM)
                    $('#createdDate').val(
                        formatDateTimeAMPM(b.CreatedDate || b.createdDate)
                    );

                    $("#bookModal").modal("show");
                },
                error: function () {
                    alert("Error fetching book details");
                }
            });
        }





        function deleteBook(bookUid) {

            $.ajax({
                url: '@Url.Action("Delete", "Book")',
                type: 'POST',
                data: { bookUid: bookUid },

                success: function (response) {

                    if (!response || response.success !== true) {
                        toastr.error(response?.message || "Delete failed");
                        return;
                    }

                    let msg = response.message?.toString() || "Book deleted successfully";

                    if (msg.includes('-')) {
                        msg = msg.split('-').slice(1).join('-').trim();
                    }

                    msg = msg.replace(/}+$/, '').trim();

                    toastr.success(msg);

                    setTimeout(() => {
                        location.reload();
                    }, 1800);
                },

                error: function (xhr) {
                    console.error("DELETE ERROR:", xhr.responseText);
                    toastr.error("Error deleting book");
                }
            });
        }



        $(document).ready(function () {

            dataTable = $('#booksTable').DataTable({
                data: bookData,
                columns: [
                    { data: 'title', render: (d, t, r) => d || r.Title || '' },
                    { data: 'author', render: (d, t, r) => d || r.Author || '' },
                    { data: 'isbn', render: (d, t, r) => d || r.ISBN || '' },
                    { data: 'publishedYear', render: (d, t, r) => d || r.PublishedYear || '' },
                    { data: 'quantity', render: (d, t, r) => d || r.Quantity || '' },
                    { data: 'availableCopies', render: (d, t, r) => d || r.AvailableCopies || '' },
                    {
                        data: null,
                        orderable: false,
                        render: function (d, t, r) {
                            var id = r.bookUid || r.BookUid;
                            return `
                                <div class="action-icons">
                                    <a class="view-icon" onclick="viewBook('${id}')">
                                        <i class="bi bi-eye-fill"></i>
                                    </a>
                                    <a class="edit-icon" onclick="editBook('${id}')">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <a class="delete-icon" onclick="deleteBook('${id}')">
                                        <i class="bi bi-trash-fill"></i>
                                    </a>
                                </div>`;
                        }
                    }
                ]
            });

        $("#btnAddBook").click(function () {

            // Reset form
            $('#bookForm')[0].reset();
            $('#bookUid').val('');

            // Enable all inputs
            $("#bookForm input").prop("disabled", false);

            // ❌ HIDE CreatedDate ONLY FOR ADD
            $('.created-date-row').addClass('d-none');
            $('#createdDate').val('');

            // Modal setup
            $("#bookModalLabel").text("Add New Book");
            $("#btnSaveBook").data("mode", "create");

            $("#bookModal").modal("show");
        });



            $('#btnSaveBook').click(function () {

                if (!validateForm()) return;
                if (!showBootstrapValidation()) return;

                var bookUidVal = $('#bookUid').val();
                var bookUid = bookUidVal && bookUidVal !== ""
                    ? parseInt(bookUidVal)
                    : 0;

                var formData = {
                    bookUid: bookUid,
                    title: $('#title').val().trim(),
                    author: $('#author').val().trim(),
                    isbn: $('#isbn').val().trim(),
                    publishedYear: $('#publishedYear').val()
                        ? parseInt($('#publishedYear').val())
                        : null,
                    quantity: parseInt($('#quantity').val()),
                    availableCopies: parseInt($('#availableCopies').val())
                };

                var apiUrl = bookUid === 0
                    ? '@Url.Action("CreateBook", "Book")'
                    : '@Url.Action("UpdateBook", "Book")';

                $.ajax({
                    url: apiUrl,
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    data: JSON.stringify(formData),

                    success: function (response) {

                        if (!response || response.success !== true) {

                            if (response?.message === "Invalid data" && $('#publishedYear').val()) {
                                toastr.error("Year must be within the current year");
                                return;
                            }

                            toastr.error(response?.message || "Operation failed");
                            return;
                        }

                        let msg = response.message.toString();

                        if (msg.includes('-')) {
                            msg = msg.split('-').slice(1).join('-').trim();
                        }

                        msg = msg.replace(/}+$/, '').trim();

                        toastr.success(msg);

                        $('#bookModal').modal('hide');

                        setTimeout(function () {
                            location.reload();
                        }, 1700);
                    },

                    error: function (xhr) {

                        $('#publishedYear').removeClass('is-invalid');

                        if (xhr.responseJSON && xhr.responseJSON.message) {

                            if (xhr.responseJSON.message.includes("Current year")) {
                                $('#publishedYearError').text("Year must be within the current year.");
                                $('#publishedYear').addClass('is-invalid');
                                return;
                            }

                            toastr.error(xhr.responseJSON.message);
                            return;
                        }

                        toastr.error("Something went wrong. Please try again.");
                    }
                });
            });


            // 🔹 ADD THIS AT THE END OF SCRIPT (NOT INSIDE CLICK HANDLERS)
            $('#bookModal').on('hidden.bs.modal', function () {
                $('#publishedYear').removeClass('is-invalid');
                $('#publishedYearError').text("Published Year is required.");
            });

        });

    </script>
}
